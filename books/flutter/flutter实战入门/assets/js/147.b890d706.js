(window.webpackJsonp=window.webpackJsonp||[]).push([[147],{847:function(s,n,e){"use strict";e.r(n);var a=e(44),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"futurebuilder"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#futurebuilder"}},[s._v("#")]),s._v(" FutureBuilder")]),s._v(" "),e("h3",{attrs:{id:"展示异步任务状态"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#展示异步任务状态"}},[s._v("#")]),s._v(" 展示异步任务状态")]),s._v(" "),e("p",[s._v("当有一个Future（异步）任务需要展示给用户时，可以使用FutureBuilder控件来完成，比如向服务器发送数据成功时显示成功提示：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("var _future = Future.delayed(Duration(seconds: 3), () {\n    return '老孟，一个有态度的程序员';\n  });\n\nFutureBuilder(\n      future: _future,\n      builder: (context, snapshot) {\n        var widget;\n        if (snapshot.connectionState == ConnectionState.done) {\n          if (snapshot.hasError) {\n            widget = Icon(\n              Icons.error,\n              color: Colors.red,\n              size: 48,\n            );\n          } else {\n            widget = Icon(\n              Icons.check_circle,\n              color: Colors.green,\n              size: 36,\n            );\n          }\n        } else {\n          widget = Padding(\n            padding: EdgeInsets.all(20),\n            child: CircularProgressIndicator(),\n          );\n        }\n\n        return Center(\n          child: Container(\n            height: 100,\n            width: 100,\n            decoration: BoxDecoration(\n                border: Border.all(color: Colors.grey),\n                borderRadius: BorderRadius.all(Radius.circular(10))),\n            child: widget,\n          ),\n        );\n      },\n    );\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br")])]),e("p",[s._v("效果如下：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200221132718431.gif",alt:""}})]),s._v(" "),e("p",[s._v("在Future任务中出现异常如何处理，下面模拟出现异常，修改"),e("code",[s._v("_future")]),s._v(":")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("var _future = Future.delayed(Duration(seconds: 3), () {\n    return Future.error('');\n  });\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("效果如下：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200221135229907.gif",alt:""}})]),s._v(" "),e("p",[e("code",[s._v("builder")]),s._v("是FutureBuilder的构建函数，在这里可以判断状态及数据显示不同的UI，\nConnectionState的状态包含四种："),e("code",[s._v("none")]),s._v("、"),e("code",[s._v("waiting")]),s._v("、"),e("code",[s._v("active")]),s._v("、"),e("code",[s._v("done")]),s._v("，但我们只需要关注"),e("code",[s._v("done")]),s._v("状态，此状态表示Future执行完成，"),e("code",[s._v("snapshot")]),s._v("参数的类型是"),e("code",[s._v("AsyncSnapshot<T>")]),s._v("。")]),s._v(" "),e("h3",{attrs:{id:"listview加载网络数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#listview加载网络数据"}},[s._v("#")]),s._v(" ListView加载网络数据")]),s._v(" "),e("p",[s._v("FutureBuilder还有一个比较常用的场景：网络加载数据并列表展示，这是一个非常常见的功能，在网络请求过程中显示loading，请求失败时显示失败UI，成功时显示成功UI。")]),s._v(" "),e("p",[s._v("模拟成功网络请求，通常会返回json字符串：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("var _future = Future.delayed(Duration(seconds: 3), () {\n    return 'json 字符串';\n  });\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("构建FutureBuilder控件：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("FutureBuilder(\n      future: _future,\n      builder: (context, snapshot) {\n        var widget;\n        if (snapshot.connectionState == ConnectionState.done) {\n          if (snapshot.hasError) {\n            widget = _loadingErrorWidget();\n          } else {\n            widget = _dataWidget(snapshot.data);\n          }\n        } else {\n          widget = _loadingWidget();\n        }\n        return widget;\n      },\n    );\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br")])]),e("p",[s._v("构建loading控件：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("_loadingWidget() {\n    return Center(\n      child: Padding(\n        padding: EdgeInsets.all(20),\n        child: CircularProgressIndicator(),\n      ),\n    );\n  }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("构建网络加载失败控件：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("_loadingErrorWidget() {\n    return Center(\n      child: Text('数据加载失败，请重试。'),\n    );\n  }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("数据加载成功，构建数据展示控件：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("_dataWidget(data) {\n    return ListView.separated(\n      itemBuilder: (context, index) {\n        return Container(\n          height: 60,\n          alignment: Alignment.center,\n          child: Text(\n            '$index',\n            style: TextStyle(fontSize: 20),\n          ),\n        );\n      },\n      separatorBuilder: (context, index) {\n        return Divider();\n      },\n      itemCount: 10,\n    );\n  }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[s._v("效果如下：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20200221161622309.gif",alt:""}})]),s._v(" "),e("p",[s._v("模拟网络加载失败：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("var _future = Future.delayed(Duration(seconds: 3), () {\n    return Future.error('');\n  });\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("效果如下：")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/2020022114581227.gif",alt:""}})]),s._v(" "),e("p",[s._v("通过上面的示例说明FutureBuilder控件极大的简化了异步任务相关显示的控件，不再需要开发者自己维护各种状态以及更新时调用"),e("code",[s._v("State.setState")]),s._v("。")]),s._v(" "),e("h3",{attrs:{id:"防止futurebuilder重绘"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#防止futurebuilder重绘"}},[s._v("#")]),s._v(" 防止FutureBuilder重绘")]),s._v(" "),e("p",[s._v("FutureBuilder是一个StatefulWidget控件，如果在FutureBuilder控件节点的父节点重绘"),e("code",[s._v("rebuild")]),s._v("，那么FutureBuilder也会重绘，这不仅耗费不必要的资源，如果是网络请求还会消耗用户的流量，这是非常糟糕的体验，如何解决这个问题？")]),s._v(" "),e("p",[s._v("通过源代码发现FutureBuilder重绘逻辑是这样的：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@override\n  void didUpdateWidget(FutureBuilder<T> oldWidget) {\n    super.didUpdateWidget(oldWidget);\n    if (oldWidget.future != widget.future) {\n      if (_activeCallbackIdentity != null) {\n        _unsubscribe();\n        _snapshot = _snapshot.inState(ConnectionState.none);\n      }\n      _subscribe();\n    }\n  }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[s._v("FutureBuilder在重建时判断旧的"),e("code",[s._v("future")]),s._v("和新的"),e("code",[s._v("future")]),s._v("是否相等，如果不相等才会重建，所以我们只需要让其相等即可，有人可能会以为设置的"),e("code",[s._v("future")]),s._v("是同一个函数，如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" _future() async{\n    ...\n  }\n\nFutureBuilder(\n\tfuture: _future(),\n\t...\n)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("上面的方式是不相等的，是错误的用法，可以将_future方法赋值给变量：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("var _mFuture;\n\n  @override\n  void initState() {\n    // TODO: implement initState\n    super.initState();\n    _mFuture = _future();\n  }\n\n _future() async{\n    ...\n  }\n\nFutureBuilder(\n\tfuture: _mFuture,\n\t...\n)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);